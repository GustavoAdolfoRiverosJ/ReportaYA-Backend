###############################################################################
# TEST FLUJO COMPLETO: REVISION → PROCESO → RESUELTA → CERRADA
# ===========================================================================
# Fecha: 21 de noviembre de 2025
# Descripción: Validación completa de endpoints integrados:
#   - Notificaciones (registro token FCM)
#   - Asignación (Operador asigna Técnico)
#   - Historial de Estados (auditoría de cambios)
#   - Completar Reporte (Técnico con fotos)
#   - Cerrar Reporte (Operador aprueba)
#
# FLUJO COMPLETO:
# 0. Registrar token FCM para notificaciones
# 1. Crear cuentas (Ciudadano, Técnico, Operador)
# 2. Crear reporte (estado inicial: PENDIENTE)
# 3. Cambiar a REVISION (manualmente)
# 4. Crear Asignación → REVISION → PROCESO (automático + historial + notificación)
# 5. Técnico completa → PROCESO → RESUELTA (con fotos + historial + notificación)
# 6. Operador cierra → RESUELTA → CERRADA (historial + notificación)
# 7. Verificar Historial completo del reporte
###############################################################################

@baseUrl = http://localhost:8080/api
@baseHistorial = http://localhost:8080/historial-estados
@baseNotificaciones = http://localhost:8080/notificaciones
@contentType = application/json

# Variables dinámicas (actualizar con IDs reales después de cada paso)
@ciudadanoId = 3
@tecnicoId = 2
@operadorId = 1
@reporteId = 8



GET {{baseUrl}}/reportes?estado=REVISION&page=0

###############################################################################
# PASO 2: CREAR REPORTE (Estado inicial: PENDIENTE)
###############################################################################

### 2.1) Ciudadano crea reporte
POST {{baseUrl}}/reportes
Content-Type: {{contentType}}

{
  "titulo": "TEST: FINAL HISTORIAL",
  "descripcion": " Jr. Los Olivos 123",
  "cuentaId": {{ciudadanoId}},
  "ubicacion": {
    "latitud": -12.0464,
    "longitud": -77.0428,
    "direccion": "Jr. Los Olivos 123, Lima"
  }
}

# RESPUESTA ESPERADA: 201 Created
# Estado: PENDIENTE
# ✅ Se crea registro en HistorialEstado: null → PENDIENTE
# → Copiar "id" y actualizar @reporteId

### 2.2) Verificar historial inicial (debe tener 1 registro)
GET {{baseHistorial}}/reporte/{{reporteId}}

# RESPUESTA ESPERADA: 200 OK
# [
#   {
#     "estadoAnterior": null,
#     "estadoNuevo": "PENDIENTE",
#     "fechaCambio": "..."
#   }
# ]

###############################################################################
# PASO 3: CAMBIAR REPORTE A REVISION (Operador revisa)
###############################################################################

### 3.1) Cambiar estado a REVISION ESTO SE INJECTA EN LOS ENDPOINTS ASIGANAR , COMPLETAR Y RECHAZAR-AUDITO , NO ESTA IMPLEMENTADO EN CREAR REPORTE.
// SE DEBE CREAR UN ENDPOINT PARA REVISAR EL REPORTE PENDIENTE A REVISION. Y INJECTAR EL CAMBIO DE ESTADO, DE LA MISMA FORMA QUE EN ASIGNAR Y COMPLETAR.
PATCH {{baseUrl}}/reportes/{{reporteId}}/estado?nuevoEstado=REVISION

# RESPUESTA ESPERADA: 200 OK
# Estado: REVISION
# ✅ Se registra en HistorialEstado: PENDIENTE → REVISION
# ✅ Se envía notificación al ciudadano: "El estado de tu reporte cambió a REVISION"

### 3.2) Verificar historial (debe tener 2 registros)
GET {{baseHistorial}}/reporte/{{reporteId}}

# RESPUESTA ESPERADA: 200 OK
# [
#   { "estadoAnterior": null, "estadoNuevo": "PENDIENTE", ... },
#   { "estadoAnterior": "PENDIENTE", "estadoNuevo": "REVISION", ... }
# ]

###############################################################################
# PASO 4: CREAR ASIGNACIÓN (Operador asigna Técnico)
# REVISION → PROCESO (automático)
###############################################################################

### 4.1) Operador asigna técnico al reporte
POST {{baseUrl}}/asignaciones
Content-Type: {{contentType}}

{
  "reporteId": {{reporteId}},
  "operadorId": {{operadorId}},
  "tecnicoId": {{tecnicoId}},
  "prioridad": "ALTA"
}

# RESPUESTA ESPERADA: 201 Created
# Estado del reporte: PROCESO (cambio automático)
# ✅ Se registra en HistorialEstado: REVISION → PROCESO
# ✅ Se envía notificación al ciudadano: "El estado de tu reporte cambió a PROCESO"
# ✅ Prioridad actualizada a ALTA

### 4.2) Verificar estado del reporte NO FUNCIONA
GET {{baseUrl}}/reportes/{{reporteId}}

# RESPUESTA ESPERADA: 200 OK
# Estado: PROCESO
# Prioridad: ALTA

### 4.3) Verificar historial (debe tener 3 registros)
GET {{baseHistorial}}/reporte/{{reporteId}}

# RESPUESTA ESPERADA: 200 OK
# [
#   { "estadoAnterior": null, "estadoNuevo": "PENDIENTE", ... },
#   { "estadoAnterior": "PENDIENTE", "estadoNuevo": "REVISION", ... },
#   { "estadoAnterior": "REVISION", "estadoNuevo": "PROCESO", ... }
# ]

### 4.4) Verificar reportes asignados al técnico FUNCIONA
GET {{baseUrl}}/tecnicos/{{tecnicoId}}/reportes?estado=PROCESO&page=0

# RESPUESTA ESPERADA: 200 OK
# Debe aparecer el reporte con id={{reporteId}} en estado PROCESO

###############################################################################
# PASO 5: TÉCNICO COMPLETA REPORTE (Con fotos obligatorias)
# PROCESO → RESUELTA
###############################################################################

### 5.1) Técnico completa reporte con evidencias fotográficas
PATCH {{baseUrl}}/tecnicos/{{tecnicoId}}/reportes/{{reporteId}}/completar
Content-Type: {{contentType}}

{
  "comentarioResolucion": "Fuga reparada exitosamente. Se cambió la tubería dañada y se verificó el sellado completo.",
  "fotos": [
    {
      "tipo": "INICIAL",
      "descripcion": "Foto inicial de la fuga antes de la reparación",
      "archivoBase64": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
    },
    {
      "tipo": "PROCESO",
      "descripcion": "Foto durante el proceso de reparación de tubería",
      "archivoBase64": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
    },
    {
      "tipo": "FINAL",
      "descripcion": "Foto final del trabajo completado sin fuga",
      "archivoBase64": "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg=="
    }
  ]
}

# RESPUESTA ESPERADA: 200 OK
# Estado: RESUELTA
# ✅ Se guardan 3 fotos (INICIAL, PROCESO, FINAL)
# ✅ Se actualiza comentarioResolucion
# ✅ Se registra en HistorialEstado: PROCESO → RESUELTA
# ✅ Se envía notificación al ciudadano: "Tu reporte fue resuelto"

### 5.2) Verificar estado del reporte
GET {{baseUrl}}/reportes/{{reporteId}}

# RESPUESTA ESPERADA: 200 OK
# Estado: RESUELTA
# comentarioResolucion: "Fuga reparada exitosamente..."

### 5.3) Verificar historial (debe tener 4 registros)
GET {{baseHistorial}}/reporte/{{reporteId}}

# RESPUESTA ESPERADA: 200 OK
# [
#   { "estadoAnterior": null, "estadoNuevo": "PENDIENTE", ... },
#   { "estadoAnterior": "PENDIENTE", "estadoNuevo": "REVISION", ... },
#   { "estadoAnterior": "REVISION", "estadoNuevo": "PROCESO", ... },
#   { "estadoAnterior": "PROCESO", "estadoNuevo": "RESUELTA", ... }
# ]

### 5.4) Verificar reportes en auditoría del operador
GET {{baseUrl}}/operador/reportes-auditoria?estado=RESUELTA&page=0

# RESPUESTA ESPERADA: 200 OK
# Debe aparecer el reporte con id={{reporteId}} en estado RESUELTA

###############################################################################
# PASO 6: OPERADOR CIERRA/APRUEBA REPORTE (Auditoría)
# RESUELTA → CERRADA
###############################################################################

### 6.1 Operador rechaza el reporte después de auditoría
# : Operador rechaza intento 1
# RESUELTA → RECHAZADO_AUDITO (contador=2)
###############################################################################
POST {{baseUrl}}/operador/reportes/{{reporteId}}/rechazar-audito
Content-Type: application/json

{
  "operadorId": {{operadorId}},
  "comentarioRechazo": "Se requieren verificaciones adicionales. Intento 2 rechazado."
}



### 6.2) Operador cierra el reporte después de auditoría
POST {{baseUrl}}/operador/reportes/{{reporteId}}/cerrar
Content-Type: {{contentType}}

{
  "operadorId": {{operadorId}},
  "comentarioCierre": "Auditoría completada satisfactoriamente. El trabajo cumple con los estándares de calidad. Fotos verificadas y comentario técnico aprobado."
}

# RESPUESTA ESPERADA: 200 OK
# Estado: CERRADA
# ✅ Se actualiza comentarioCierre
# ✅ Se actualiza fechaCierre
# ✅ Se registra operadorCierre
# ✅ Se registra en HistorialEstado: RESUELTA → CERRADA
# ✅ Se envía notificación al ciudadano: "Tu reporte fue cerrado"



### 6.3) Verificar estado final del reporte NO FUNCIONA
GET {{baseUrl}}/reportes/{{reporteId}}

# RESPUESTA ESPERADA: 200 OK
# Estado: CERRADA
# comentarioCierre: "Auditoría completada satisfactoriamente..."
# fechaCierre: "2025-11-21T..."
# operadorCierre: { id: 3, ... }

###############################################################################
# PASO 7: VERIFICACIÓN FINAL - HISTORIAL COMPLETO
###############################################################################

### 7.1) Verificar historial completo 
GET {{baseHistorial}}/reporte/{{reporteId}}


### 7.2) Verificar reportes cerrados del operador
GET {{baseUrl}}/operador/reportes-auditoria?estado=CERRADA&page=0

# RESPUESTA ESPERADA: 200 OK
# Debe aparecer el reporte con id={{reporteId}} en estado CERRADA

